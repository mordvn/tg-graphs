"""
Toxicity Detector
–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Ç–æ–∫—Å–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ –æ–±—â–µ–Ω–∏–∏:
- –ì–∞–∑–ª–∞–π—Ç–∏–Ω–≥
- –û–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ
- –ü–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è
- –ö–æ–Ω—Ç—Ä–æ–ª—å
- –û–±–≤–∏–Ω–µ–Ω–∏—è
"""
from collections import defaultdict
from datetime import datetime
import streamlit as st
import pandas as pd

# –ì–∞–∑–ª–∞–π—Ç–∏–Ω–≥ ‚Äî –ø–æ–ø—ã—Ç–∫–∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è –≤ —Å–≤–æ—ë–º –≤–æ—Å–ø—Ä–∏—è—Ç–∏–∏
GASLIGHTING_MARKERS = {
    '—Ç—ã –≤—Å—ë –≤—ã–¥—É–º—ã–≤–∞–µ—à—å', '—Ç–µ–±–µ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å', '—ç—Ç–æ–≥–æ –Ω–µ –±—ã–ª–æ',
    '—Ç—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–º–Ω–∏—à—å', '—É —Ç–µ–±—è —Å –≥–æ–ª–æ–≤–æ–π', '—Ç—ã —Å—É–º–∞—Å—à–µ–¥',
    '—Ç—ã –ø–∞—Ä–∞–Ω–æ–∏–∫', '—Ç—ã –ø—Ä–µ—É–≤–µ–ª–∏—á–∏–≤–∞–µ—à—å', '—Ç—ã –¥—Ä–∞–º–∞—Ç–∏–∑–∏—Ä—É–µ—à—å',
    '–Ω–µ –±—ã–ª–æ —Ç–∞–∫–æ–≥–æ', '—è —Ç–∞–∫–æ–≥–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª', '—è —Ç–∞–∫–æ–≥–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª–∞',
    '—ç—Ç–æ —Ç–≤–æ–∏ —Ñ–∞–Ω—Ç–∞–∑–∏–∏', '—Ç—ã –ø—Ä–∏–¥—É–º–∞–ª–∞', '—Ç—ã –ø—Ä–∏–¥—É–º–∞–ª',
    '—ç—Ç–æ –≤—Å—ë –≤ —Ç–≤–æ–µ–π –≥–æ–ª–æ–≤–µ', '—Ç—ã –≤—Å—ë –ø–µ—Ä–µ–≤—Ä–∞–ª–∞', '—Ç—ã –≤—Å—ë –ø–µ—Ä–µ–≤—Ä–∞–ª',
    '–Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –ª—é–¥–∏ —Ç–∞–∫ –Ω–µ –¥—É–º–∞—é—Ç', '—É —Ç–µ–±—è –ø—Ä–æ–±–ª–µ–º—ã',
    '—Ç–µ–±–µ –ª–µ—á–∏—Ç—å—Å—è –Ω–∞–¥–æ', '—Ç—ã –Ω–µ–∞–¥–µ–∫–≤–∞—Ç', '—É—Å–ø–æ–∫–æ–π—Å—è —É–∂–µ',
    '—Ä–∞—Å—Å–ª–∞–±—å—Å—è', '–Ω–µ –¥–µ–ª–∞–π –∏–∑ –º—É—Ö–∏ —Å–ª–æ–Ω–∞', '—Ç—ã —Å–ª–∏—à–∫–æ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω',
}

# –û–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ
DEVALUATION_MARKERS = {
    '–∫–∞–∫–∞—è —Ä–∞–∑–Ω–∏—Ü–∞', '—ç—Ç–æ –µ—Ä—É–Ω–¥–∞', '—ç—Ç–æ –º–µ–ª–æ—á–∏', '–Ω–µ –≤–∞–∂–Ω–æ',
    '–∫–æ–≥–æ —ç—Ç–æ –≤–æ–ª–Ω—É–µ—Ç', '–Ω–∏–∫–æ–º—É –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ', '–∑–∞–±–µ–π',
    '–Ω–µ –Ω–∞–ø—Ä—è–≥–∞–π—Å—è', '–ø–æ–¥—É–º–∞–µ—à—å', '–¥–∞ –ª–∞–¥–Ω–æ —Ç–µ–±–µ', '–∏ —á—Ç–æ',
    '–Ω—É –∏ –ª–∞–¥–Ω–æ', '–ø—Ä–æ–µ—Ö–∞–ª–∏', '—Ç–æ–∂–µ –º–Ω–µ –ø—Ä–æ–±–ª–µ–º–∞', '–Ω–µ –Ω—É–¥–∏',
    '—Ö–≤–∞—Ç–∏—Ç –Ω—ã—Ç—å', '–¥–æ—Å—Ç–∞–ª–∞ —Å–æ —Å–≤–æ–∏–º–∏', '–¥–æ—Å—Ç–∞–ª —Å–æ —Å–≤–æ–∏–º–∏',
    '—ç—Ç–æ –Ω–µ –≤–∞–∂–Ω–æ', '–∑–∞–±—É–¥—å', '–Ω–µ –∑–∞–±–∏–≤–∞–π –≥–æ–ª–æ–≤—É', '–Ω–µ –º–æ—Ä–æ—á—å',
    '—Ç–≤–æ–∏ –ø—Ä–æ–±–ª–µ–º—ã', '–º–Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ', '–º–Ω–µ –ø–ª–µ–≤–∞—Ç—å', '–º–µ–Ω—è –Ω–µ –≤–æ–ª–Ω—É–µ—Ç',
    '—ç—Ç–æ —Ç–≤–æ—è –ø—Ä–æ–±–ª–µ–º–∞', '—Ä–∞–∑–±–∏—Ä–∞–π—Å—è —Å–∞–º–∞', '—Ä–∞–∑–±–∏—Ä–∞–π—Å—è —Å–∞–º',
}

# –ü–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è
PASSIVE_AGGRESSION_MARKERS = {
    '–¥–µ–ª–∞–π –∫–∞–∫ —Ö–æ—á–µ—à—å', '—Ç–µ–±–µ –≤–∏–¥–Ω–µ–µ', '–∫–∞–∫ —Å–∫–∞–∂–µ—à—å',
    '–Ω—É –∫–æ–Ω–µ—á–Ω–æ', '–∞–≥–∞, –∫–æ–Ω–µ—á–Ω–æ', '–Ω—É –¥–∞, –Ω—É –¥–∞',
    '—è –Ω–µ –æ–±–∏–∂–∞—é—Å—å', '–≤—Å—ë –Ω–æ—Ä–º–∞–ª—å–Ω–æ', '–≤—Å—ë —Ö–æ—Ä–æ—à–æ',  # –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ—Å–ª–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
    '–∫–∞–∫ –∑–Ω–∞–µ—à—å', '—Ç–µ–±–µ —Ä–µ—à–∞—Ç—å', '–º–Ω–µ –±–µ–∑ —Ä–∞–∑–Ω–∏—Ü—ã',
    '–º–Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ —á—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å', '–Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ',
    '–∑–∞–±–µ–π –Ω–∞ –º–µ–Ω—è', '–Ω–µ –æ–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏—è', '—è –ø—Ä–∏–≤—ã–∫–ª–∞', '—è –ø—Ä–∏–≤—ã–∫',
    '–ª–∞–¥–Ω–æ', '—Ö–æ—Ä–æ—à–æ',  # –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –ø–æ—Å–ª–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    'ok', '–æ–∫', '–æ–∫–µ–π', '—è—Å–Ω–æ', '–ø–æ–Ω—è—Ç–Ω–æ',  # –•–æ–ª–æ–¥–Ω—ã–µ –æ–¥–Ω–æ—Å–ª–æ–∂–Ω—ã–µ
}

# –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
CONTROL_MARKERS = {
    '–≥–¥–µ —Ç—ã', '—Ç—ã –≥–¥–µ', '—Å –∫–µ–º —Ç—ã', '—Ç—ã —Å –∫–µ–º', '–∫—Ç–æ —Ç–∞–º',
    '–ø–æ—á–µ–º—É –Ω–µ –æ—Ç–≤–µ—á–∞–µ—à—å', '–ø–æ—á–µ–º—É –Ω–µ –±–µ—Ä—ë—à—å —Ç—Ä—É–±–∫—É',
    '–ø–µ—Ä–µ–∑–≤–æ–Ω–∏ —Å–µ–π—á–∞—Å –∂–µ', '–æ—Ç–≤–µ—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ', '–≥–¥–µ —Ç–µ–±—è –Ω–æ—Å–∏—Ç',
    '—Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –∂–¥–∞—Ç—å', '–æ–ø—è—Ç—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—à—å',
    '–Ω–µ —Ö–æ–¥–∏ —Ç—É–¥–∞', '–Ω–µ –æ–±—â–∞–π—Å—è —Å', '—è –∑–∞–ø—Ä–µ—â–∞—é',
    '—Ç–µ–±–µ –Ω–µ–ª—å–∑—è', '—è –Ω–µ —Ä–∞–∑—Ä–µ—à–∞—é', '–±–µ–∑ –º–µ–Ω—è –Ω–µ —Ö–æ–¥–∏',
    '–ø–æ–∫–∞–∂–∏ –ø–µ—Ä–µ–ø–∏—Å–∫—É', '–¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω', '–ø–∞—Ä–æ–ª—å –æ—Ç',
    '–¥–æ–±–∞–≤—å –º–µ–Ω—è', '–æ—Ç–∫—Ä–æ–π –ª–æ–∫–∞—Ü–∏—é', '—Å–∫–∏–Ω—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é',
    '–ø–æ—á–µ–º—É –ª–∞–π–∫–Ω—É–ª–∞', '–ø–æ—á–µ–º—É –ª–∞–π–∫–Ω—É–ª', '–∫—Ç–æ —ç—Ç–æ –Ω–∞ —Ñ–æ—Ç–æ',
    '—á—Ç–æ –∑–∞ –¥–µ–≤—É—à–∫–∞', '—á—Ç–æ –∑–∞ –ø–∞—Ä–µ–Ω—å', '–∫—Ç–æ —Ç–µ–±–µ –∑–≤–æ–Ω–∏–ª',
    '–∫—Ç–æ –Ω–∞–ø–∏—Å–∞–ª', '—Å –∫–µ–º —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–ª–∞', '—Å –∫–µ–º —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–ª',
    '–≤–µ—á–Ω–æ —Ç—ã', '–æ–ø—è—Ç—å —Ç—ã', '—Ç—ã –≤—Å–µ–≥–¥–∞', '—Ç—ã –Ω–∏–∫–æ–≥–¥–∞',
    '—Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ', '—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≥–æ–≤–æ—Ä–∏—Ç—å',
}

# –ü—Ä—è–º—ã–µ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –∞–≥—Ä–µ—Å—Å–∏—è
DIRECT_AGGRESSION_MARKERS = {
    '–∏–¥–∏–æ—Ç', '–∏–¥–∏–æ—Ç–∫–∞', '–¥–µ–±–∏–ª', '–¥–µ–±–∏–ª–∫–∞', '–¥—É—Ä–∞–∫', '–¥—É—Ä–∞',
    '—Ç—É–ø–æ–π', '—Ç—É–ø–∞—è', '—Ç—É–ø–∏—Ü–∞', '–∫—Ä–µ—Ç–∏–Ω', '–∫—Ä–µ—Ç–∏–Ω–∫–∞',
    '—É—Ä–æ–¥', '—É—Ä–æ–¥–∏–Ω–∞', '–º—Ä–∞–∑—å', '—Ç–≤–∞—Ä—å', '—Å—É–∫–∞', '–±–ª—è–¥—å',
    '–∑–∞—Ç–∫–Ω–∏—Å—å', '–∑–∞–∫—Ä–æ–π —Ä–æ—Ç', '–ø–æ—à—ë–ª –Ω–∞', '–ø–æ—à–ª–∞ –Ω–∞',
    '–∏–¥–∏ –Ω–∞—Ö—É–π', '–∏–¥–∏ –Ω–∞ —Ö—É–π', '–ø–æ—à—ë–ª –Ω–∞—Ö—É–π',
    '–Ω–µ–Ω–∞–≤–∏–∂—É —Ç–µ–±—è', '–¥–æ—Å—Ç–∞–ª', '–¥–æ—Å—Ç–∞–ª–∞', '–±–µ—Å–∏—à—å',
    '–∑–∞–¥–æ–ª–±–∞–ª', '–∑–∞–¥–æ–ª–±–∞–ª–∞', '–Ω–∞–¥–æ–µ–ª', '–Ω–∞–¥–æ–µ–ª–∞',
    '–æ—Ç–≤–∞–ª–∏', '–æ—Ç—Å—Ç–∞–Ω—å', '–æ—Ç—ä–µ–±–∏—Å—å', '—Å–≤–∞–ª–∏',
    '–ø–æ—à—ë–ª –≤–æ–Ω', '–ø–æ—à–ª–∞ –≤–æ–Ω', '—É–±–∏—Ä–∞–π—Å—è',
}

# –£–≥—Ä–æ–∑—ã –∏ —à–∞–Ω—Ç–∞–∂
THREATS_MARKERS = {
    '—É–π–¥—É –æ—Ç —Ç–µ–±—è', '–±—Ä–æ—à—É —Ç–µ–±—è', '–Ω–∞–π–¥—É –¥—Ä—É–≥–æ–≥–æ', '–Ω–∞–π–¥—É –¥—Ä—É–≥—É—é',
    '–ø–æ–∂–∞–ª–µ–µ—à—å', '—Ç—ã –µ—â—ë –ø–æ–∂–∞–ª–µ–µ—à—å', '–±—É–¥–µ—à—å –∂–∞–ª–µ—Ç—å',
    '—è —Ç–µ–±–µ –ø–æ–∫–∞–∂—É', '—Ç—ã —É –º–µ–Ω—è –ø–æ–ø–ª—è—à–µ—à—å', '—è —Ç–µ–±–µ —É—Å—Ç—Ä–æ—é',
    '—Ä–∞—Å—Å–∫–∞–∂—É –≤—Å–µ–º', '–≤—Å–µ —É–∑–Ω–∞—é—Ç', '–≤—ã–ª–æ–∂—É',
    '–µ—Å–ª–∏ –Ω–µ', '–∞ —Ç–æ', '–∏–Ω–∞—á–µ', '–∏–ª–∏ —è',
    '–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑', '–≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑', '–±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É',
    '—ç—Ç–æ –∫–æ–Ω–µ—Ü', '—Ö–≤–∞—Ç–∏—Ç', '–≤—Å—ë –∫–æ–Ω—á–µ–Ω–æ',
}


def get_text(msg):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    text = msg.get('text', '')
    if isinstance(text, list):
        parts = []
        for part in text:
            if isinstance(part, str):
                parts.append(part)
            elif isinstance(part, dict) and 'text' in part:
                parts.append(part['text'])
        return ' '.join(parts)
    return str(text) if text else ''


def parse_date(date_str):
    return datetime.strptime(date_str, "%Y-%m-%dT%H:%M:%S")


def find_markers(text, markers):
    """–ù–∞—Ö–æ–¥–∏—Ç –º–∞—Ä–∫–µ—Ä—ã –≤ —Ç–µ–∫—Å—Ç–µ"""
    text_lower = text.lower()
    found = []
    for marker in markers:
        if marker in text_lower:
            found.append(marker)
    return found


def run_plugin(data):
    messages = data.get("messages", [])
    chat_name = data.get("name", "Chat")
    
    if not messages:
        st.warning("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
        return
    
    st.subheader(f"üîç –î–µ—Ç–µ–∫—Ç–æ—Ä –¢–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ ‚Äî {chat_name}")
    st.markdown("""
    –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ç–æ–∫—Å–∏—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ–±—â–µ–Ω–∏—è.
    
    ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ê–ª–≥–æ—Ä–∏—Ç–º –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è. 
    –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –∏–Ω–æ–≥–¥–∞ —Ñ—Ä–∞–∑—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —à—É—Ç–∫—É –∏–ª–∏ –∏–º–µ—é—Ç –¥—Ä—É–≥–æ–π —Å–º—ã—Å–ª.
    """)
    
    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏
    categories = {
        'üå´Ô∏è –ì–∞–∑–ª–∞–π—Ç–∏–Ω–≥': GASLIGHTING_MARKERS,
        'üíî –û–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ': DEVALUATION_MARKERS,
        'üòí –ü–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è': PASSIVE_AGGRESSION_MARKERS,
        'üéØ –ö–æ–Ω—Ç—Ä–æ–ª—å': CONTROL_MARKERS,
        'üí¢ –ê–≥—Ä–µ—Å—Å–∏—è': DIRECT_AGGRESSION_MARKERS,
        '‚ö†Ô∏è –£–≥—Ä–æ–∑—ã/–®–∞–Ω—Ç–∞–∂': THREATS_MARKERS,
    }
    
    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    user_stats = defaultdict(lambda: {cat: {'count': 0, 'examples': []} for cat in categories})
    monthly_stats = defaultdict(lambda: defaultdict(lambda: defaultdict(int)))
    
    for msg in messages:
        sender = msg.get('from')
        if not sender:
            continue
            
        text = get_text(msg)
        if not text or len(text) < 3:
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        for cat_name, markers in categories.items():
            found = find_markers(text, markers)
            if found:
                user_stats[sender][cat_name]['count'] += len(found)
                if len(user_stats[sender][cat_name]['examples']) < 5:
                    user_stats[sender][cat_name]['examples'].append({
                        'text': text[:150],
                        'markers': found,
                        'date': msg.get('date', '')[:10]
                    })
                
                # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
                try:
                    dt = parse_date(msg['date'])
                    month = dt.strftime('%Y-%m')
                    monthly_stats[month][sender][cat_name] += len(found)
                except:
                    pass
    
    if not user_stats:
        st.success("‚úÖ –¢–æ–∫—Å–∏—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ!")
        return
    
    # –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
    st.markdown("### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏")
    
    users = list(user_stats.keys())
    
    table_data = []
    for user in users:
        row = {'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å': user}
        total_toxic = 0
        for cat_name in categories.keys():
            count = user_stats[user][cat_name]['count']
            row[cat_name] = count
            total_toxic += count
        row['–í–°–ï–ì–û'] = total_toxic
        table_data.append(row)
    
    df = pd.DataFrame(table_data)
    df = df.sort_values('–í–°–ï–ì–û', ascending=False)
    st.dataframe(df, hide_index=True)
    
    # –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    st.markdown("### üîé –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑")
    
    for user in users:
        total_toxic = sum(user_stats[user][cat]['count'] for cat in categories)
        if total_toxic == 0:
            continue
            
        with st.expander(f"üë§ {user} ‚Äî {total_toxic} —Ç–æ–∫—Å–∏—á–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤"):
            for cat_name in categories:
                cat_stats = user_stats[user][cat_name]
                if cat_stats['count'] > 0:
                    st.markdown(f"**{cat_name}** ‚Äî {cat_stats['count']} —Å–ª—É—á–∞–µ–≤")
                    
                    for example in cat_stats['examples']:
                        st.caption(f"üìÖ {example['date']}: _{example['text']}..._")
                        st.caption(f"   ‚Üí –ú–∞—Ä–∫–µ—Ä—ã: {', '.join(example['markers'])}")
                    
                    st.divider()
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if len(users) >= 2:
        st.markdown("### ‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ")
        
        col1, col2 = st.columns(2)
        
        totals = {user: sum(user_stats[user][cat]['count'] for cat in categories) for user in users}
        
        for idx, user in enumerate(users):
            with [col1, col2][idx % 2]:
                st.markdown(f"**{user}**")
                
                for cat_name in categories:
                    count = user_stats[user][cat_name]['count']
                    if count > 0:
                        # –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
                        if count > 20:
                            st.error(f"{cat_name}: {count}")
                        elif count > 10:
                            st.warning(f"{cat_name}: {count}")
                        elif count > 5:
                            st.info(f"{cat_name}: {count}")
                        else:
                            st.caption(f"{cat_name}: {count}")
    
    # –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
    if len(monthly_stats) > 2:
        st.markdown("### üìà –î–∏–Ω–∞–º–∏–∫–∞ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ –ø–æ –º–µ—Å—è—Ü–∞–º")
        
        import matplotlib.pyplot as plt
        
        months = sorted(monthly_stats.keys())
        
        fig, ax = plt.subplots(figsize=(12, 5))
        
        for user in users:
            totals = []
            for month in months:
                total = sum(monthly_stats[month][user].values())
                totals.append(total)
            ax.plot(months, totals, marker='o', label=user, linewidth=2)
        
        ax.set_xlabel('–ú–µ—Å—è—Ü')
        ax.set_ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫—Å–∏—á–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤')
        ax.set_title('–ö–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º')
        ax.legend()
        ax.tick_params(axis='x', rotation=45)
        plt.tight_layout()
        st.pyplot(fig)
    
    # –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    st.markdown("### üí° –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è")
    
    st.markdown("""
    **–£—Ä–æ–≤–Ω–∏ —Ç—Ä–µ–≤–æ–≥–∏:**
    - üü¢ **1-5 –º–∞—Ä–∫–µ—Ä–æ–≤** ‚Äî –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å—é –∏–ª–∏ —à—É—Ç–∫–∞–º–∏
    - üü° **6-15 –º–∞—Ä–∫–µ—Ä–æ–≤** ‚Äî –°—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ
    - üü† **16-30 –º–∞—Ä–∫–µ—Ä–æ–≤** ‚Äî –ï—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω —Ç–æ–∫—Å–∏—á–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
    - üî¥ **30+ –º–∞—Ä–∫–µ—Ä–æ–≤** ‚Äî –°–µ—Ä—å—ë–∑–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π —Ñ–ª–∞–≥
    
    **–û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:**
    - üå´Ô∏è **–ì–∞–∑–ª–∞–π—Ç–∏–Ω–≥** ‚Äî –ø–æ–ø—ã—Ç–∫–∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è –≤ —Å–µ–±–µ
    - üéØ **–ö–æ–Ω—Ç—Ä–æ–ª—å** ‚Äî –∂–µ–ª–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∂–∏–∑–Ω—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞
    - ‚ö†Ô∏è **–£–≥—Ä–æ–∑—ã** ‚Äî –ª—é–±—ã–µ —Ñ–æ—Ä–º—ã —à–∞–Ω—Ç–∞–∂–∞
    
    **–ú–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (–Ω–æ –≤–∞–∂–Ω—ã–µ):**
    - üíî **–û–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ** ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ —Å—Ç–∏–ª–µ–º –æ–±—â–µ–Ω–∏—è
    - üòí **–ü–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è** ‚Äî —á–∞—Å—Ç–æ –Ω–µ–æ—Å–æ–∑–Ω–∞–Ω–Ω–∞—è
    """)
    
    # –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
    st.markdown("### üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞")
    
    for user in users:
        total = sum(user_stats[user][cat]['count'] for cat in categories)
        
        # –í–∑–≤–µ—à–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ (–±–æ–ª–µ–µ —Å–µ—Ä—å—ë–∑–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–µ—Å—è—Ç –±–æ–ª—å—à–µ)
        weighted = (
            user_stats[user]['üå´Ô∏è –ì–∞–∑–ª–∞–π—Ç–∏–Ω–≥']['count'] * 3 +
            user_stats[user]['üéØ –ö–æ–Ω—Ç—Ä–æ–ª—å']['count'] * 3 +
            user_stats[user]['‚ö†Ô∏è –£–≥—Ä–æ–∑—ã/–®–∞–Ω—Ç–∞–∂']['count'] * 4 +
            user_stats[user]['üí¢ –ê–≥—Ä–µ—Å—Å–∏—è']['count'] * 2 +
            user_stats[user]['üíî –û–±–µ—Å—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ']['count'] * 1 +
            user_stats[user]['üòí –ü–∞—Å—Å–∏–≤–Ω–∞—è –∞–≥—Ä–µ—Å—Å–∏—è']['count'] * 1
        )
        
        if weighted > 50:
            st.error(f"üö® **{user}**: –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏. –≠—Ç–æ —Å–µ—Ä—å—ë–∑–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π —Ñ–ª–∞–≥.")
        elif weighted > 25:
            st.warning(f"‚ö†Ô∏è **{user}**: –ó–∞–º–µ—Ç–Ω—ã–µ —Ç–æ–∫—Å–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã. –°—Ç–æ–∏—Ç –æ–±—Å—É–¥–∏—Ç—å.")
        elif weighted > 10:
            st.info(f"üìä **{user}**: –ï—Å—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ.")
        elif total > 0:
            st.success(f"üü¢ **{user}**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏.")
        else:
            st.success(f"‚úÖ **{user}**: –¢–æ–∫—Å–∏—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.")

